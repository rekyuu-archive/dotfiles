#!/bin/bash

# kyo.li uploader script
#
# requirements:
#   maim
#   slop
#   jq
#   xclip
#   libnotify
#
# $ screenshot all
#   for fullscreen
#
# $ screenshot region
#   for region selection
#
# $ screenshot webm
#   for webm screen recording
#   press `q` to stop the recording if ran from a terminal.
#   otherwise, run the above command again to stop recording.

# Defines the URLs to make the POST
URL="http://kyo.li"
API="/api/upload"
UPLOAD=$URL$API

# Defines the folder and file names
DIR=~/img/screenshots/$(date "+%Y-%m")
if [ "$1" == "webm" ]; then
	FILENAME=$(date "+%Y-%m-%d_%H-%M-%S").webm
else
	FILENAME=$(date "+%Y-%m-%d_%H-%M-%S").png
fi

# Makes the directory if it doesn't exist
mkdir -p $DIR
FILEPATH=$DIR/$FILENAME

# Runs maim depending on the script argument
if [ "$1" == "all" ]; then
	maim $FILEPATH
elif [ "$1" == "region" ]; then
	maim -s $FILEPATH -c 1,0,0,1 -p 5 -b 1
elif [ "$1" == "webm" ]; then
	# Checks if ffmpeg is running, terminates it if it is.
	# Otherwise, starts the recording.

	if [ "$(pidof ffmpeg)" ]; then
		kill -SIGTERM $(pidof ffmpeg)
	else
		eval $(slop -c 1,0,0,1 -p 5 -b 1)
		ffmpeg -f x11grab -s "$W"x"$H" -i :0.0+$X,$Y -f pulse -i default $FILEPATH
	fi
fi

if [ -e $FILEPATH ]; then
	paplay ~/sfx/smrpg_click.wav

	# Uploads the image and returns the url
	RESPONSE=$(curl -s -F file_0=@$FILEPATH -F filename=$FILENAME $UPLOAD)
	IMAGE=$(echo $RESPONSE | jq -r .urls[0])
	LINK=$URL$IMAGE

	# Copies the link to clipboard and notifies the user
	echo $LINK | xclip -selection c
	notify-send $LINK
	paplay ~/sfx/smrpg_item.wav
fi
